---
title: "Lab 4: Analyzing Data with Time Series Plots."
output: 
  html_document:
    toc: true # table of content true
    depth: 2  # up to two depths of headings (specified by #, ##)
    number_sections: false  ## if you want number sections at each table header
    theme: cerulean  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xlsx)
library(NWCEd)
library(leaflet)
library(ggplot2)
library(dplyr)
options(warn = -1)
```
<script>
  function hidecode(id) {
    document.getElementById(id).style.display = "none";
  }
  
  function togglecode(id,senderid) {
    var e=document.getElementById(id);
    var e2=document.getElementById(senderid);
    if(e.style.display == 'block') {
      e.style.display = 'none';
      e2.innerHTML='Show Code';
    } else {
      e.style.display = 'block';
      e2.innerHTML='Hide Code';
    }
  }

</script>

## Introduction
<div style="text-align:justify">

</div>

## Important Questions to Ask Yourself

1. What information is contained in a time series plot?
2. How do I interpret the quality of a dataset using a box plot?
3. Who is the intended audience I am trying to communicate information with?

## Useful Terms and Acronyms

Term               | Defintion
----------------   | ---------------------------------------------------
Time Series        | A series of values obtained at successive times
NWIS               | National Water Information System
Area Weighted Mean | The sum of area-weighted values divided by the total area
Water Balance      | A method used to account for water flowing in and out of a system
Double-Mass Curve  | A graphical method used to study consistency and trends in data

## Exercise 1 

<br>

#### Step 1
<div style="text-align:justify">
In this exercise we will learn how to obtain an HUC ID from the National Water Cenus Data-Portal (NWC-DP).  For this lab we will need to download runoff data in addition to the ET and precipitation data which requires slightly different steps from those shown in **Lab 3**.  To begin, log on to the National Water Census Data Portal (NWC-DP) using the following URL: <http://cida.usgs.gov/nwc/>.  The home page is shown in **Figure 1** below.  Click on the tab titled, "Water Budget" in the Menu ribbon on the left of the page or anywhere in the large Water Budget icon to access the Water Budget tool.
</div>
<br>

![**Figure 1: The NWC-DP homepage.**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure1.jpg)

<br>

In order to put together an accurate water balance, we need to know the streamflow within the desired watershed to account for all the water entering and leaving the site.  The United States Geological Survey (USGS) has put together a network called National Water Information System (NWIS).  The **NWIS** collects, records, and stores streamflow data through the use of gages which are installed in several locations throughout the United States.  For more information about the NWIS, please visit <http://waterdata.usgs.gov/nwis/sw>.  To obtain a HUC ID that meets the desired requirements, first select the **12 Digit** Huc layer in the **`Huc Layer:`** dropdown box. Next, click on the **`Turn Gages On`** to turn on the NWIS gages.  Your screen should look similar to the image shown below in **Figure 2** below.

<br>

![**Figure 2: Selecting the Huc layer and gage. layer.**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure2.jpg)

<br>

The watershed we will analyze is the "Rock Canyon-Provo River" watershed located in Provo, Utah.  In the search bar, search for "Provo River" and select "Provo River UT Utah County".  Select Rock Canyon-Provo River watershed as shown in **Figure 3** below.  Note that there is a blue dot indicating the location of a NWIS gage within the boundary of the watershed.

<br>

![**Figure 3: Selecting the Huc layer and gage. layer.**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure3.jpg)

<br>

After selecting the desired watershed, a new page will load which shows the HUC ID, the watershed name, and and some other information.  Next, click on the **`Show Accumulated Water Budget`** button located at the top left of the page.  The precipitation, streamflow, and ET time series graph is displayed at the bottom of the page.  A map of the watershed including the location of the NWIS gage is displayed towards the center of the page.  These features are shown in **Figure 4** below.

<br>

![**Figure 4: NWIS gage location and time series. graph.**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure4.jpg)

<br>

We now know for sure that this location has availabe precipitation, streamflow, and ET data.  We know by looking at the upper left area of the page that the HUC ID is **160202030505**.  We can now download our desired datasets and begin our analysis.  The ET and precipitation datasets have been plotted below.
</div>

<br>

#### Step 2
<div style="text-align:justify">
With the HUC ID obtained, we are ready to download the data and generate our water balance.  For this section, the data has already been downloaded and the plots generated.  The code which performed these tasks in RStudio has been included as a guide for practice later in the **Try It Yourself** section.

<br>
Below is an enlarged map of the watershed we selected and the surrounding area.  If you are viewing this lab in a web browser, you can place your cursor over the map and use the scroll wheel on the mouse to zoom in and out.  Clicking and dragging the mouse on the map allows you to pan to different locations on the map.  
</div>
<br>

```{r map watershed, echo=FALSE}
library(NWCEd)
library(leaflet)
# Enter the huc12 to be analyzed like this:
huc12<-"160202030505"
NWCwatershed<-getNWCWatershed(huc="160202030505",local=FALSE)
coords<-NWCwatershed$features[[1]]$geometry$coordinates[[1]][[1]]
coords<-as.data.frame(matrix(unlist(coords),nrow=length(coords),byrow = T))
names(coords)<-c('lon','lat')

leaflet() %>%
  setView(lng = mean(coords$lon), lat = mean(coords$lat), zoom = 9) %>%
  addTiles() %>% 
  addGeoJSON(NWCwatershed, weight = 2, color = "#444444", fill = FALSE)
```
<br>
<div style="text-align:center">
  <a id="codetoggle1" onclick="togglecode('graphcode1','codetoggle1');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode1">
library(NWCEd)
library(leaflet)
huc12<-"160202030505"
NWCwatershed<-getNWCWatershed(huc="160202030505",local=FALSE)
coords<-NWCwatershed$features[[1]]$geometry$coordinates[[1]][[1]]
coords<-as.data.frame(matrix(unlist(coords),nrow=length(coords),byrow = T))
names(coords)<-c('lon','lat')
leaflet() %>%
  setView(lng = mean(coords$lon), lat = mean(coords$lat), zoom = 9) %>%
  addTiles() %>% 
  addGeoJSON(NWCwatershed, weight = 2, color = "#444444", fill = FALSE)
</code>
</div>

<br>

Zoom in closer to the watershed.  What percentage of the watershed is within the city limits compared to in the mountainous areas?  Do the people living within the watershed boundaries use all the water within the watershed?  No, they don't.  In fact, 70,000 acre-feet of water is diverted out of the Provo River to the Salt Lake Valley to the north via the 36 mile long Jordan Aqueduct (http://www.usbr.gov/projects/Project.jsp?proj_Name=Central+Utah+Project+-+Bonneville+Unit).  Knowing how much water is contained within a given watershed is critical for supporting the population within and without the boundaries of the watershed.

<br>

Lets plot the annual precipitation, ET, and difference.  The values of the precipitation and ET datasets from the NWC-DP are the area weighted mean precipitationa and ET values.   The difference line is the difference between the annual precipitation and the annual ET.  It tells us how much of the rainfall is left over after the effects of ET have taken place.

```{r data setup, echo=FALSE}
# Load required libraries.
library(ggplot2)
library(NWCEd)
# Super basic plot of precip and et.
NWCdata<-getNWCData(huc=huc12)
# annualize et data.
annual_dataet<-annualize(NWCdata$et, method=sum)
# Add a group attribute to all et data.
annual_dataet$group<-'ET'
# Annualize prcp data.
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
# Add a group attribute to all prcp data.
annual_dataprcp$group<-'P'
# Merge prcp and et together.
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
# Create a difference variable.
annual_diff<-as.data.frame(annual_union$data.y - annual_union$data.x)
# Give the difference data a name.
names(annual_diff) = c('data')
# Add the difference data to a group.
annual_diff$group<-'diff'
# Add the same year data to the difference data.
annual_diff$year<-annual_union$year
```
<br>
```{r plot, echo=FALSE}
library(scales)
library(ggplot2)
require(stats)
plotData<-rbind(annual_dataet,annual_dataprcp,annual_diff)
ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("mm") + 
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Difference Between Precipitation and ET", colour = "Explanation") +
  theme(legend.position = c(0.91, 0.83)) + scale_color_manual(values=c("#990066", "#339966", "#FF0000"))
```

<div style="text-align:center">
  <a id="codetoggle2" onclick="togglecode('graphcode2','codetoggle2');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode2">
library(ggplot2)
library(NWCEd)
NWCdata<-getNWCData(huc=huc12)
annual_dataet<-annualize(NWCdata$et, method=sum)
annual_dataet$group<-'ET'
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
annual_dataprcp$group<-'P'
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
annual_diff<-as.data.frame(annual_union$data.y - annual_union$data.x)
names(annual_diff) = c('data')
annual_diff$group<-'diff'
annual_diff$year<-annual_union$year
library(scales)
library(ggplot2)
require(stats)
plotData<-rbind(annual_dataet,annual_dataprcp,annual_diff)
ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("mm") + 
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Difference Between Precipitation and ET", colour = "Explanation") +
  theme(legend.position = c(0.91, 0.83)) + scale_color_manual(values=c("#990066", "#339966", "#FF0000"))
</code>
</div>

<br>

From the graph, we see the precipitation data in red, the ET data under the precipitation line in green, and the difference of the two datasets in maroon below the ET line.  As the graph shows, there is only ET data available from the year 2000 through 2014 in our dataset.  How does the precipitation line look in comparison to the ET line?  Which shows more variation from year to year?  Regarding precipitation, what years stick out to you?  Does there appear to be any patterns?  Could global climate variability be evidenced in the precipitation dataset?

<br>

<div style= "width: 400px; height= 300px;PADDING-RIGHT: 5px; float: left">
![**Figure 5: Utah State Park during the 1983 flood (http://www.utahlake.gov/1983-flooding/).**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure5.jpg)
</div>
<div style="text-align:justify">
During the years from from 1981 to 1983 this region experienced record amounts of precipitation.  Major streets were sand-bagged and transformed into temporary rivers.  **Figure 5** to the left shows flooding at the Utah State Park.  What about the year 1988?  From 1988 to 1992 the regrion experienced the second most severe drought recorded.  Utah Lake which receives the water from the Provo River is on average about 10.5 feet deep (http://www.wasatchwater.org/utah-lake-part-5-the-lakes-future/).  During the drought period from 1988-1992, the lake dropped 8 feet (http://www.slcdocs.com/utilities/NewsEvents/news2003/news12232003.htm).  In a short period of 10 years, this region experienced one of the worst floods as well as one of the worst droughts on record.  Effective management of water resources can dampen the effects felt from everchanging weather.
</div>

<br>
<br>

![**Figure 6: Utah Lake surface elevations (http://www.utahlake.gov/1983-flooding/).**](/Research/RStudioProject/NWCEd/inst/Lab4_NWC-DP_Images/Figure6.jpg)

<br>

It turns out there are more variables that go into balancing a water budget than just precipitation and ET.  Water that percolates into the ground or is otherwise stored in lakes or reservoirs within the watershed must be accounted for as well.  In the next step, we will discuss how to account for this unaccounted water using runoff data.

<br>

#### Step 3
<div style="text-align:justify">
We have seen the effects of changing weather through the example of Utah Lake and the surrounding region.  It is the responsibility of water managers, hydrologysts, and engineers to provide water to the people that live within the respective area of influence as well as prepare for potential problems such as flooding and droughts.  To be able to fulfill these responsibilities, all the water within the watershed must be accounted for.  

<br>

A common method of accounting for the water within the watershed, or in this case the HUC, is by performing a **water balance**.  Water balances are used to account for all water flowing into and out of a system.  Water balances are based on the principle that in a closed system mass is neither created or destroyed.  Applying this to the water balance, all water flowing into the system must exit the system or be stored in the system.  Lets look at the closed system defined by the 12-Digit HUC ID **031601090601** within the Town Creek-Cane Creek watershed.  This HUC contains Jasper, Alabama within its boundaries.  From the NWC-DP, the precipitation, ET, and streamflow datasets have been downloaded and plotted below for this HUC.

<br>

```{r waterbalance plot, echo=FALSE }
NWCdata<-getNWCData(huc="031501070601", local = FALSE)
NWCwatershed<-getNWCWatershed(huc="031501070601",local=FALSE)
areasqft<-NWCwatershed$features[[1]]$properties$areaacres*43560
NWCdata$et$data<-NWCdata$et$data*0.0032808
annual_dataet<-annualize(NWCdata$et, method=sum)
annual_dataet$group<-'ET'
NWCdata$prcp$data<-NWCdata$prcp$data*0.0032808
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
annual_dataprcp$group<-'P'
NWCdata$streamflow$data<-NWCdata$streamflow$data*60*60*24/areasqft
annual_datastrf<-annualize(NWCdata$streamflow,method=sum)
annual_datastrf$group<-'Q'
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
annual_union<-merge(annual_union,annual_datastrf,by.x="year",by.y="year")
names(annual_union)<-c("year","ET","groupET","P","groupP","Q","groupQ")
annual_diff<-as.data.frame(annual_union$P - annual_union$ET - annual_union$Q)
names(annual_diff) = c('data')
annual_diff$group<-'diff'
annual_diff$year<-annual_union$year
plotData<-rbind(annual_dataet,annual_dataprcp,annual_datastrf,annual_diff)

ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("ft") +
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Basic Diff Plot", colour = "Explanation") +
  scale_color_manual(values=c("#990066", "#339966", "#FF0000", "#3300FF"))
```
<div style="text-align:center">
  <a id="codetoggle3" onclick="togglecode('graphcode3','codetoggle3');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode3">
NWCdata<-getNWCData(huc="031501070601", local = FALSE)
NWCwatershed<-getNWCWatershed(huc="031501070601",local=FALSE)
areasqft<-NWCwatershed$features[[1]]$properties$areaacres*43560
NWCdata$et$data<-NWCdata$et$data*0.0032808
annual_dataet<-annualize(NWCdata$et, method=sum)
annual_dataet$group<-'ET'
NWCdata$prcp$data<-NWCdata$prcp$data*0.0032808
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
annual_dataprcp$group<-'P'
NWCdata$streamflow$data<-NWCdata$streamflow$data*60*60*24/areasqft
annual_datastrf<-annualize(NWCdata$streamflow,method=sum)
annual_datastrf$group<-'Q'
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
annual_union<-merge(annual_union,annual_datastrf,by.x="year",by.y="year")
names(annual_union)<-c("year","ET","groupET","P","groupP","Q","groupQ")
annual_diff<-as.data.frame(annual_union$P - annual_union$ET - annual_union$Q)
names(annual_diff) = c('data')
annual_diff$group<-'diff'
annual_diff$year<-annual_union$year
plotData<-rbind(annual_dataet,annual_dataprcp,annual_datastrf,annual_diff)
ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("ft") +
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Basic Diff Plot", colour = "Explanation") +
  scale_color_manual(values=c("#990066", "#339966", "#FF0000", "#3300FF"))
</code>
</div>
<br>

Precipitation, ET, streamflow, and the difference are marked in red, green, blue, and maroon, respectively.  The diff line represents the leftover preciptiation after ET and streamflow have been subtracted from the original precipitation.  The diff line includes water stored in the ground through percolation and in lakes and reservoirs within the system boundaries.  Look at the diff line on the plot above.  What years experienced positive storage?  What years experienced negative storage?  This may be a little bit difficult to read.  Lets take a look at a different plot which shows the storage for the same location.

<br>

```{r storage barplot, echo=FALSE}
library(dplyr)
NWCdata<-getNWCData(huc="031501070601", local = FALSE)
NWCwatershed<-getNWCWatershed(huc="031501070601",local=FALSE)
areasqft<-NWCwatershed$features[[1]]$properties$areaacres*43560
NWCdata$et$data<-NWCdata$et$data*0.0032808
annual_dataet<-annualize(NWCdata$et, method=sum)
annual_dataet$group<-'ET'
NWCdata$prcp$data<-NWCdata$prcp$data*0.0032808
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
annual_dataprcp$group<-'P'
NWCdata$streamflow$data<-NWCdata$streamflow$data*60*60*24/areasqft
annual_datastrf<-annualize(NWCdata$streamflow,method=sum)
annual_datastrf$group<-'Q'
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
annual_union<-merge(annual_union,annual_datastrf,by.x="year",by.y="year")
names(annual_union)<-c("year","ET","groupET","P","groupP","Q","groupQ")
annual_diff<-as.data.frame(annual_union$P - annual_union$ET - annual_union$Q)
names(annual_diff) = c('data')
annual_diff$group<-'diff'
annual_diff$year<-annual_union$year

annual_diff = annual_diff%>%
  mutate(pos = data >= 0)

ggplot(annual_diff, aes(x=year, y=data, fill=pos)) + geom_bar(stat='identity', position = 'identity', color='black', size=0.25)+ scale_fill_manual(values=c('#FFDDDD','#CCEEFF'), guide = FALSE) + xlab("Year") + ylab("Annual Storage (ft)") + ggtitle("Annual Storage from 2000 to 2010") 
```

<div style="text-align:center">
  <a id="codetoggle4" onclick="togglecode('graphcode4','codetoggle4');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode4">
library(dplyr)
NWCdata<-getNWCData(huc="031501070601", local = FALSE)
NWCwatershed<-getNWCWatershed(huc="031501070601",local=FALSE)
areasqft<-NWCwatershed$features[[1]]$properties$areaacres*43560
NWCdata$et$data<-NWCdata$et$data*0.0032808
annual_dataet<-annualize(NWCdata$et, method=sum)
annual_dataet$group<-'ET'
NWCdata$prcp$data<-NWCdata$prcp$data*0.0032808
annual_dataprcp<-annualize(NWCdata$prcp, method=sum)
annual_dataprcp$group<-'P'
NWCdata$streamflow$data<-NWCdata$streamflow$data*60*60*24/areasqft
annual_datastrf<-annualize(NWCdata$streamflow,method=sum)
annual_datastrf$group<-'Q'
annual_union<-merge(annual_dataet,annual_dataprcp,by.x="year",by.y="year")
annual_union<-merge(annual_union,annual_datastrf,by.x="year",by.y="year")
names(annual_union)<-c("year","ET","groupET","P","groupP","Q","groupQ")
annual_diff<-as.data.frame(annual_union$P - annual_union$ET - annual_union$Q)
names(annual_diff) = c('data')
annual_diff$group<-'diff'
annual_diff$year<-annual_union$year
annual_diff = annual_diff%>%
  mutate(pos = data >= 0)
ggplot(annual_diff, aes(x=year, y=data, fill=pos)) + geom_bar(stat='identity', position = 'identity', color='black', size=0.25)+ scale_fill_manual(values=c('#FFDDDD','#CCEEFF'), guide = FALSE) + xlab("Year") + ylab("Annual Storage (ft)") + ggtitle("Annual Storage from 2000 to 2010") 
</code>
</div>
<br>

This bar graph makes it very easy to see which years had positive storage and which years had negative storage.  If we are assuming that the law of conservation of mass applies to water balances, how can we have negative storage?  We must remember that negative storage for our time series simply means that there is no water being stored.  In our case, there is water being pulled out of storage.  Where are possible locations for water to be stored within this HUC?  Using the same methods as described in **Step 2** zoom in and look for possible storage places within the system.

<br>

```{r jasperhuc data input, echo=FALSE}
# Enter the huc12 to be analyzed like this:
huc12<-"031601090601"
```

<br>

```{r jasperhuc map watershed, echo=FALSE}
library(NWCEd)
library(leaflet)


# Get watershed geometry and put it on a map.
NWCwatershed<-getNWCWatershed(huc=huc12,local=FALSE)
coords<-NWCwatershed$features[[1]]$geometry$coordinates[[1]][[1]]
coords<-as.data.frame(matrix(unlist(coords),nrow=length(coords),byrow = T))
names(coords)<-c('lon','lat')
leaflet() %>% 
  setView(lng = mean(coords$lon), lat = mean(coords$lat), zoom = 9) %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}") %>%
  addWMSTiles(baseUrl = "http://cida.usgs.gov/nwc/geoserver/gwc/service/wms", 
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 1),                attribution = "Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012") %>% 
  addGeoJSON(NWCwatershed, weight = 5, color = "#ff7800", fill = FALSE)
```
<br>
<div style="text-align:center">
  <a id="codetoggle5" onclick="togglecode('graphcode5','codetoggle5');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode5">
huc12<-"031601090601"
library(NWCEd)
library(leaflet)
NWCwatershed<-getNWCWatershed(huc=huc12,local=FALSE)
coords<-NWCwatershed$features[[1]]$geometry$coordinates[[1]][[1]]
coords<-as.data.frame(matrix(unlist(coords),nrow=length(coords),byrow = T))
names(coords)<-c('lon','lat')
leaflet() %>% 
  setView(lng = mean(coords$lon), lat = mean(coords$lat), zoom = 9) %>%
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}") %>%
  addWMSTiles(baseUrl = "http://cida.usgs.gov/nwc/geoserver/gwc/service/wms", 
              options = WMSTileOptions(format = "image/png", transparent = TRUE, opacity = 1),                attribution = "Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012") %>% 
  addGeoJSON(NWCwatershed, weight = 5, color = "#ff7800", fill = FALSE)
</code>
</div>
<br>

Storage is mainly comprised of ground water, although additional storage areas can include lakes and rivers.

<br>

#### Step 4
<br>

How do we know if our precipitation data is good to use?  In the field, there is the possibility that rain gages are moved or are damaged for a period of time.  Problems that occur in the field must be taken into consideration and the data adjusted to reflect the conditions of the site being analyzed.  One method used to identify inconsistencies in a precipitation dataset is a **Double-Mass Curve**.  For analyzing precipitation data at a site, the annual precipitation data of nearby rain gages are collected and cumulated.  The mean cumulative annual data is then plotted against the mean annual cumulative precipitation for the surrounding sites including the site being analyzed.  For more information on double-mass curves, please visit <http://pubs.usgs.gov/wsp/1541b/report.pdf>.  

<br>

Lets check the consistency and long-term trends of the precipitation data for HUC# 031601090601.  For this exercise it is important to note that the precipitation data used is actually the area weighted mean precipitation based on data obtained through rain gages.  The surrounding sites are the nearest surrounding 12-Digit HUCs.  For the purposes of the exercise, these differences are negligible. Below is the code used to collect, cumulate, find the cumulative mean for 4 sites, and plot the results.

```{r double-mass plot, echo=T}

# Download data from NWC-DP for HUC# 031601090601
NWCdata<-getNWCData(huc="031601090601", local = FALSE)
# Assign NWCdataprcp variable the precipitation dataset 
NWCdataprcp1<-NWCdata$prcp
# Convert units from mm to inches
NWCdataprcp1$data<-NWCdataprcp1$data*.0393701
# Convert data from daily to annual precipitation
NWCdataprcpsumannual1<-annualize(NWCdataprcp1, method = sum)
# Cumulates annual precipitation data for the site
NWcdataprcpsumannualcum1<-cumsum(NWCdataprcpsumannual1$data)

# Repeat previous steps for next three HUC#
NWCdata<-getNWCData(huc="031601090405", local = FALSE)
NWCdataprcp2<-NWCdata$prcp
NWCdataprcp2$data<-NWCdataprcp2$data*.0393701
NWCdataprcpsumannual2<-annualize(NWCdataprcp2, method = sum)
NWcdataprcpsumannualcum2<-cumsum(NWCdataprcpsumannual2$data)

NWCdata<-getNWCData(huc="031601090403", local = FALSE)
NWCdataprcp3<-NWCdata$prcp
NWCdataprcp3$data<-NWCdataprcp3$data*.0393701
NWCdataprcpsumannual3<-annualize(NWCdataprcp3, method = sum)
NWcdataprcpsumannualcum3<-cumsum(NWCdataprcpsumannual3$data)

NWCdata<-getNWCData(huc="031601090308", local = FALSE)
NWCdataprcp4<-NWCdata$prcp
NWCdataprcp4$data<-NWCdataprcp4$data*.0393701
NWCdataprcpsumannual4<-annualize(NWCdataprcp4, method = sum)
NWcdataprcpsumannualcum4<-cumsum(NWCdataprcpsumannual4$data)

# Averaging the annual precipitation for the 4 sites
annualaverage <- (NWCdataprcpsumannual1$data + NWCdataprcpsumannual2$data + NWCdataprcpsumannual3$data + NWCdataprcpsumannual4$data)/4
# Cumulates the averaged annual precipitation for the 4 sites
annualaveragecum<-cumsum(annualaverage)
# Creates a dataframe with mean cumulative annual precipitation and the cumulative annual precipitation for the first HUC
plot1<-data.frame(x = annualaveragecum, y = NWcdataprcpsumannualcum1)
# Plots the newly created dataframe
ggplot(plot1, aes(x=x, y=y)) + geom_point() + geom_smooth(color="blue") + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Double Mass Analysis for HUC# 031601090601 Precip Data") + theme(panel.background = element_rect(fill = "grey75"))

```

<br>
As we can see, the data points for the most part fall into a straight line.  This indicates there is strong correlation among the data points and the measurements are consistent throughout the dataset.  Lets take a look at a case where eroneous data are plotted on a double-mass curve.

```{r double-mass plot 2, echo=FALSE}

# Download data from NWC-DP for HUC# 150601060306
NWCdata<-getNWCData(huc="150601060306", local = FALSE)
# Assign NWCdataprcp variable the precipitation dataset 
NWCdataprcp1<-NWCdata$prcp
# Convert units from mm to inches
NWCdataprcp1$data<-NWCdataprcp1$data*.0393701
# Convert data from daily to annual precipitation
NWCdataprcpsumannual1<-annualize(NWCdataprcp1, method = sum)
# Cumulates annual precipitation data for the site
NWcdataprcpsumannualcum1<-cumsum(NWCdataprcpsumannual1$data)

# Repeat previous steps for next three HUC#
NWCdata<-getNWCData(huc="150701020908", local = FALSE)
NWCdataprcp2<-NWCdata$prcp
NWCdataprcp2$data<-NWCdataprcp2$data*.0393701
NWCdataprcpsumannual2<-annualize(NWCdataprcp2, method = sum)
NWcdataprcpsumannualcum2<-cumsum(NWCdataprcpsumannual2$data)

NWCdata<-getNWCData(huc="150601060305", local = FALSE)
NWCdataprcp3<-NWCdata$prcp
NWCdataprcp3$data<-NWCdataprcp3$data*.0393701
NWCdataprcpsumannual3<-annualize(NWCdataprcp3, method = sum)
NWcdataprcpsumannualcum3<-cumsum(NWCdataprcpsumannual3$data)

# Read in manually altered dataset 
NWCdataprcpsumannual4<-read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet1")
NWcdataprcpsumannualcum4<-cumsum(NWCdataprcpsumannual4$data)
# Averaging the annual precipitation for the 4 sites
annualaverage <- (NWCdataprcpsumannual1$data + NWCdataprcpsumannual2$data + NWCdataprcpsumannual3$data + NWCdataprcpsumannual4$data)/4
# Cumulates the averaged annual precipitation for the 4 sites
annualaveragecum<-cumsum(annualaverage)
# Creates a dataframe with mean cumulative annual precipitation and the cumulative annual precipitation for the first HUC
plot4<-data.frame(x = annualaveragecum, y = NWcdataprcpsumannualcum4)
# Separates dataset at the curve break
plotsegment<-plot4[c(1:17),]
plotsegment2<-plot4[c(17:35),]
# Plots the newly created dataframe
ggplot(plot4, aes(x=x, y=y)) + geom_point() + geom_smooth(color="blue") + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ") + theme(panel.background = element_rect(fill = "grey75")) + annotate("text", x=365, y=175, label = "Break in Curve", size = 4) 
ggplot(plot4, aes(x=x, y=y)) + geom_smooth(data = plotsegment, color = "blue") + geom_smooth(data = plotsegment2, color = "yellow") + annotate("text", x=365, y=175, label = "Break in Curve", size = 4) + theme(panel.background = element_rect(fill = "grey75")) + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ")

```
<div style="text-align:center">
  <a id="codetoggle6" onclick="togglecode('graphcode6','codetoggle6');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode6">
NWCdata<-getNWCData(huc="150601060306", local = FALSE)
NWCdataprcp1<-NWCdata$prcp
NWCdataprcp1$data<-NWCdataprcp1$data*.0393701
NWCdataprcpsumannual1<-annualize(NWCdataprcp1, method = sum)
NWcdataprcpsumannualcum1<-cumsum(NWCdataprcpsumannual1$data)
NWCdata<-getNWCData(huc="150701020908", local = FALSE)
NWCdataprcp2<-NWCdata$prcp
NWCdataprcp2$data<-NWCdataprcp2$data*.0393701
NWCdataprcpsumannual2<-annualize(NWCdataprcp2, method = sum)
NWcdataprcpsumannualcum2<-cumsum(NWCdataprcpsumannual2$data)
NWCdata<-getNWCData(huc="150601060305", local = FALSE)
NWCdataprcp3<-NWCdata$prcp
NWCdataprcp3$data<-NWCdataprcp3$data*.0393701
NWCdataprcpsumannual3<-annualize(NWCdataprcp3, method = sum)
NWcdataprcpsumannualcum3<-cumsum(NWCdataprcpsumannual3$data)
NWCdataprcpsumannual4<-read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet1")
NWcdataprcpsumannualcum4<-cumsum(NWCdataprcpsumannual4$data)
annualaverage <- (NWCdataprcpsumannual1$data + NWCdataprcpsumannual2$data + NWCdataprcpsumannual3$data + NWCdataprcpsumannual4$data)/4
annualaveragecum<-cumsum(annualaverage)
plot4<-data.frame(x = annualaveragecum, y = NWcdataprcpsumannualcum4)
plotsegment<-plot4[c(1:17),]
plotsegment2<-plot4[c(17:35),]
ggplot(plot4, aes(x=x, y=y)) + geom_point() + geom_smooth(color="blue") + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ") + theme(panel.background = element_rect(fill = "grey75")) + annotate("text", x=365, y=175, label = "Break in Curve", size = 4) 
ggplot(plot4, aes(x=x, y=y)) + geom_smooth(data = plotsegment, color = "blue") + geom_smooth(data = plotsegment2, color = "yellow") + annotate("text", x=365, y=175, label = "Break in Curve", size = 4) + theme(panel.background = element_rect(fill = "grey75")) + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ")
</code>
</div>
<br>

We would expect the data points to plot in a linear fashion.  However, when we look at this double-mass curve, we can clearly see a break in the curve.  If we were to do some research on this hypothetical rain gage, we would find that development occured in close proximity to the gage.  A sprinkler system was installed and the gage was collecting additional readings when the sprinklers were running.  We are needing to adjust our data to reflect the natural conditions without the sprinklers.  To do this, we can multiply the "bad" data by the ratio of the slope of the "good" data.  We can use the following equation to help us adjust our data:
</div>


$$P_a=\frac{b_a}{b_0}*P_0$$

<div style="text-align:justify; clear: left">
$P_a$ = adjusted precipitation

$P_0$ = observed precipitation

$b_a$ = slope of graph of adjusted values

$b_0$ = slope of graph at the time $P_0$ was observed

<br>
The slopes of the blue line and yellow line are 0.69 and 1.55, respectively.  The slope ratio is then calculated to be 0.44.  We will now multiply the slope ratio to data from the break in the curve to the end of the dataset to correct for the error introduced by the sprinklers.  The plot below shows the change in precipitation after the data has been corrected.

<br>

```{r corrected vs uncorrected , echo=FALSE}
# Download data from NWC-DP for HUC# 150601060306
NWCdata<-getNWCData(huc="150601060306", local = FALSE)
# Assign NWCdataprcp variable the precipitation dataset 
NWCdataprcp1<-NWCdata$prcp
# Convert units from mm to inches
NWCdataprcp1$data<-NWCdataprcp1$data*.0393701
# Convert data from daily to annual precipitation
NWCdataprcpsumannual1<-annualize(NWCdataprcp1, method = sum)
# Cumulates annual precipitation data for the site
NWcdataprcpsumannualcum1<-cumsum(NWCdataprcpsumannual1$data)

# Repeat previous steps for next three HUC#

NWCdata<-getNWCData(huc="150701020908", local = FALSE)
NWCdataprcp2<-NWCdata$prcp
NWCdataprcp2$data<-NWCdataprcp2$data*.0393701
NWCdataprcpsumannual2<-annualize(NWCdataprcp2, method = sum)
NWcdataprcpsumannualcum2<-cumsum(NWCdataprcpsumannual2$data)

NWCdata<-getNWCData(huc="150601060305", local = FALSE)
NWCdataprcp3<-NWCdata$prcp
NWCdataprcp3$data<-NWCdataprcp3$data*.0393701
NWCdataprcpsumannual3<-annualize(NWCdataprcp3, method = sum)
NWcdataprcpsumannualcum3<-cumsum(NWCdataprcpsumannual3$data)

# Read in manually altered dataset 

NWCdataprcpsumannual4<-read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet2")

NWcdataprcpsumannualcum4<-cumsum(NWCdataprcpsumannual4$data)

# Averaging the annual precipitation for the 4 sites
annualaverage <- (NWCdataprcpsumannual1$data + NWCdataprcpsumannual2$data + NWCdataprcpsumannual3$data + NWCdataprcpsumannual4$data)/4

# Cumulates the averaged annual precipitation for the 4 sites
annualaveragecum<-cumsum(annualaverage)

# Creates a dataframe with mean cumulative annual precipitation and the cumulative annual precipitation for the first HUC

plot4<-data.frame(x = annualaveragecum, y = NWcdataprcpsumannualcum4)

# Plots the newly created dataframe
ggplot(plot4, aes(x=x, y=y)) + geom_point() + geom_smooth(color="green") + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ") + theme(panel.background = element_rect(fill = "grey75")) + geom_smooth(data = plotsegment , color="blue") + geom_smooth(data = plotsegment2, color="yellow")
```
<div style="text-align:center">
  <a id="codetoggle7" onclick="togglecode('graphcode7','codetoggle7');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode7">
NWCdata<-getNWCData(huc="150601060306", local = FALSE)
NWCdataprcp1<-NWCdata$prcp
NWCdataprcp1$data<-NWCdataprcp1$data*.0393701
NWCdataprcpsumannual1<-annualize(NWCdataprcp1, method = sum)
NWcdataprcpsumannualcum1<-cumsum(NWCdataprcpsumannual1$data)
NWCdata<-getNWCData(huc="150701020908", local = FALSE)
NWCdataprcp2<-NWCdata$prcp
NWCdataprcp2$data<-NWCdataprcp2$data*.0393701
NWCdataprcpsumannual2<-annualize(NWCdataprcp2, method = sum)
NWcdataprcpsumannualcum2<-cumsum(NWCdataprcpsumannual2$data)
NWCdata<-getNWCData(huc="150601060305", local = FALSE)
NWCdataprcp3<-NWCdata$prcp
NWCdataprcp3$data<-NWCdataprcp3$data*.0393701
NWCdataprcpsumannual3<-annualize(NWCdataprcp3, method = sum)
NWcdataprcpsumannualcum3<-cumsum(NWCdataprcpsumannual3$data)
NWCdataprcpsumannual4<-read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet2")
NWcdataprcpsumannualcum4<-cumsum(NWCdataprcpsumannual4$data)
annualaverage <- (NWCdataprcpsumannual1$data + NWCdataprcpsumannual2$data + NWCdataprcpsumannual3$data + NWCdataprcpsumannual4$data)/4
annualaveragecum<-cumsum(annualaverage)
plot4<-data.frame(x = annualaveragecum, y = NWcdataprcpsumannualcum4)
ggplot(plot4, aes(x=x, y=y)) + geom_point() + geom_smooth(color="green") + xlab("Mean Cumulative Precipitation (inches) ") + ylab("Cumulative Precipitation for HUC# 031601090601 (inches)") + ggtitle("Hypothetical HUC near Phoenix, AZ") + theme(panel.background = element_rect(fill = "grey75")) + geom_smooth(data = plotsegment , color="blue") + geom_smooth(data = plotsegment2, color="yellow")
</code>
</div>

<br>

```{r corrected vs uncorrected and diff plot, echo=FALSE}
library(scales)
library(ggplot2)

correcteddata<- read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet2")

uncorrecteddata<- read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet1")


correcteddata$group<-'Corrected'
drops<-c("NA.")
correcteddata<- correcteddata[,!(names(correcteddata) %in% drops)]

uncorrecteddata$group<-'Uncorrected'
drops<-c("NA.")
uncorrecteddata<- uncorrecteddata[,!(names(uncorrecteddata) %in% drops)]

datamerge<-merge(correcteddata,uncorrecteddata,by.x = "year",by.y = "year")
datadiff<-as.data.frame(datamerge$data.y-datamerge$data.x)
datadiff$year<-datamerge$year
names(datadiff) = c('data')
names(datadiff[[2]]) = c('year')

datadiff$group<-'Difference'

colnames(datadiff)<-c("data","year","group")
datadiff<-datadiff[,c(2,1,3)]

plotData<-rbind(datadiff,correcteddata,uncorrecteddata)

ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("inches") + 
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Difference Between Precipitation and ET", colour = "Explanation") +
  theme(legend.position = c(0.10, 0.83)) + scale_color_manual(values=c("#990066", "#339966", "#FF0000"))
```
<div style="text-align:center">
  <a id="codetoggle8" onclick="togglecode('graphcode8','codetoggle8');">Show Code</a>
</div>
<div style="text-align:justify; clear: left; word-wrap: break-word">
<code id="graphcode8">
library(scales)
library(ggplot2)
correcteddata<- read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet2")
uncorrecteddata<- read.xlsx("/Research/RStudioProject/NWCEd/doublemassplot2.xlsx", sheetName = "Sheet1")
correcteddata$group<-'Corrected'
drops<-c("NA.")
correcteddata<- correcteddata[,!(names(correcteddata) %in% drops)]
uncorrecteddata$group<-'Uncorrected'
drops<-c("NA.")
uncorrecteddata<- uncorrecteddata[,!(names(uncorrecteddata) %in% drops)]
datamerge<-merge(correcteddata,uncorrecteddata,by.x = "year",by.y = "year")
datadiff<-as.data.frame(datamerge$data.y-datamerge$data.x)
datadiff$year<-datamerge$year
names(datadiff) = c('data')
names(datadiff[[2]]) = c('year')
datadiff$group<-'Difference'
colnames(datadiff)<-c("data","year","group")
datadiff<-datadiff[,c(2,1,3)]
plotData<-rbind(datadiff,correcteddata,uncorrecteddata)
ggplot(plotData, aes(x=year, y=data, group=group,colour = group)) +  geom_line() +
  scale_x_discrete(name = "year") + ylab("inches") + 
  theme(axis.text.x = element_text(angle = 45)) +
  labs(title = "Difference Between Precipitation and ET", colour = "Explanation") +
  theme(legend.position = c(0.10, 0.83)) + scale_color_manual(values=c("#990066", "#339966", "#FF0000"))
</code>
</div>

<br>
As you can clearly see, not correcting the data would result in values that are substantially higher than expected.  What water management problems might occur if the uncorrected data was used in planning?
<br>


## Try It Yourself

<br>

#### Problem 1


<div style="text-align:justify; clear: left">
Describe what a bar graph, time series graph, and double-mass curve are and explain what type of information each one communicates.

<br>

#### Problem 2


Describe what a bar graph, time series graph, and double-mass curve are and explain what type of information each one communicates.

<br>


<br>
<br>

<script>
  //run this at start up
  hidecode('graphcode1');
  hidecode('graphcode2');
  hidecode('graphcode3');
  hidecode('graphcode4');
  hidecode('graphcode5');
  hidecode('graphcode6');
  hidecode('graphcode7');
  hidecode('graphcode8');
</script>

